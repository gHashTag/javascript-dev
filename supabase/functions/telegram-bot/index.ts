// Follow this setup guide to integrate the Deno language server with your editor:
// https://deno.land/manual/getting_started/setup_your_environment
// This enables autocomplete, go to definition, etc.
import { createUser } from "../create-user.ts";
import { getAiFeedback } from "../get-ai-feedback.ts";
import { bot, handleUpdate } from "../utils/bot.ts";

console.log("Hello from Functions!");

bot.command("start", async (ctx) => {
  await ctx.replyWithChatAction("typing");
  createUser(ctx);
  ctx.reply(
    `Hi, ${ctx.update.message?.from.first_name}! üöÄ –î–∞–≤–∞–π –Ω–∞—á–Ω–µ–º —Å —Ç–µ—Å—Ç–æ–≤ ‚Äì –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –Ω–∏—Ö, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ–º—É –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—é –≤ –º–∏—Ä –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è! üñ•Ô∏è‚ú® `,
    {
      reply_markup: {
        inline_keyboard: [
          [{ text: "–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç!", callback_data: "start_test" }],
        ],
      },
    },
  );
});

bot.on("message:text", async (ctx) => {
  await ctx.replyWithChatAction("typing");
  const text = ctx.message.text;
  try {
    const feedback = await getAiFeedback(text);
    await ctx.reply(feedback, { parse_mode: "Markdown" });
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ AI:", error);
  }
});

bot.start();

Deno.serve(async (req) => {
  try {
    const url = new URL(req.url);
    console.log(url, "url");
    // if (
    //   url.searchParams.get("secret") !==
    //     Deno.env.get("NEXT_PUBLIC_SUPABASE_FUNCTION_SECRET")
    // ) {
    //   return new Response("not allowed", { status: 405 });
    // }

    const result = await handleUpdate(req);
    if (!(result instanceof Response)) {
      console.error("handleUpdate –Ω–µ –≤–µ—Ä–Ω—É–ª –æ–±—ä–µ–∫—Ç Response", result);
      return new Response("Internal Server Error", { status: 500 });
    }
    return result;
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞:", err);
    return new Response("Internal Server Error", { status: 500 });
  }
});

/* To invoke locally:

  1. Run `supabase start` (see: https://supabase.com/docs/reference/cli/supabase-start)
  2. Make an HTTP request:

  curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/telegram-bot' \
    --header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0' \
    --header 'Content-Type: application/json' \
    --data '{"name":"Functions"}'

*/
